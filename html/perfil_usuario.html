<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Usuario.</title>
    <link rel="icon" type="image/png" href="../imagenes/logo_3.png" />
    <link rel="stylesheet" href="../css/perfil_usuario.css">
    <link rel="stylesheet" href="../css/modal.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">


    <link href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">

    <!--LETRA-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,wght@0,300;1,400&display=swap"
        rel="stylesheet">

    <!--Libreria alerts-->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body class="cuerpo">
    <input type="checkbox" id="check">
    <!--NAV-->
    <div class="nav">
        <label class="logo">
            <img src="../imagenes/logo_3.png" alt="">
            <span>Responsabilidad Empresarial.</span>
        </label>
        <ul>
            <!-- <li class="salir" onclick="menuToggle();"><a class="far fa-user" href="#"></a></li> -->
            <li class="salir" id="menuToggle"><a class="far fa-user" href="#"></a></li>
            <div class="menu-salir">
                <div class="info-user">
                    <div class="logo-user">
                        <a class="far fa-user"></a>
                    </div>
                    <div class="datos-usuario">
                        <div class="nombre-user">
                            <span>Jonnthan</span>
                        </div>
                        <div class="correo-user">
                            <span>jonthancuvi@gameil.com</span>
                        </div>
                    </div>
                </div>
                <ul>
                    <li onclick="ir_perfil();"><i class="far fa-user-circle"></i></i>
                        <a>Mi Perfil</a>
                    </li>
                    <li onclick="configuracion_empresa();"><i class="fas fa-building"></i></i>
                        <a>Mi Empresa</a>
                    </li>
                    <!-- <i class="fa-regular fa-comment-question"></i> -->
                    <li onclick="ir_contactanos();"><i class="fas fa-question"></i></i>
                        <a>Ayuda</a>
                    </li>
                    <!--<li><i class="fas fa-edit"></i><a href="#">Editar Perfil</a></li>-->
                    <li><i class="fas fa-sign-out-alt"></i><a onclick="salir()">Salir</a></li>
                </ul>
            </div>
        </ul>
    </div>
    <!--sidebar start-->
    <div class="sidebar">
        <label for="check" class="check1">
            <i class="fas fa-bars" id="sidebar_btn"></i>
            <!--<span>RSE Epresarial</span>-->
        </label>
        <div class="slider-encabesado">
            R S E
        </div>
        <a class="slider-opcion" onclick="ir_evaluacion();">
            <div class="slider-text">
                <i class="fas fa-poll-h"></i>
                <span>Evaluación</span>
                <div class="texto-emergente">
                    Evaluación
                </div>
            </div>
        </a>
        <a class="slider-opcion" onclick="ir_dashboard();">
            <div class="slider-text">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
                <div class="texto-emergente">
                    Dashboard
                </div>
            </div>
        </a>
        <a class="slider-opcion" onclick="ir_reporte();">
            <div class="slider-text">
                <i class="far fa-file-alt"></i>
                <span>Reporte</span>
                <div class="texto-emergente">
                    Reporte
                </div>
            </div>
        </a>
        <!-- <a class="slider-opcion" onclick="configuracion_empresa();">
            <div class="slider-text">
                <i class="fas fa-building"></i>
                <span>Empresa</span>
                <div class="texto-emergente">
                    Empresa
                </div>
            </div>
        </a> -->
        <a class="slider-opcion" onclick="ir_about();">
            <div class="slider-text">
                <i class="fas fa-info-circle"></i>
                <span>About</span>
                <div class="texto-emergente">
                    About
                </div>
            </div>
        </a>
        <a class="slider-opcion sallir-option" onclick="salir();">
            <div class="slider-text">
                <i class="fas fa-sign-out-alt"></i>
                <span>Salir</span>
                <div class="texto-emergente">
                    Salir
                </div>
            </div>
        </a>
    </div>

    <!--sidebar end-->

    <!--contenido-->
    <div class="content">

        <!--Informacion Usuario-->
        <div class="contenido">
            <div class="titulo">
                <span>Configuración Perfil.</span>
            </div>
            <div class="info-usuario">
                <div class="nombre-usuario">
                    <div class="datos">
                        <label>Nombre:</label>
                        <input type="text" id="nombre">
                    </div>
                    <div id="apellido-actulizar" class="datos">
                        <label>Apellido:</label>
                        <input type="text" id="apellido">
                    </div>
                </div>
                <div class="usuario-email">
                    <div id="correo-actualizar" class="datos">
                        <label>Usuario:</label>
                        <input type="text" id="usuario">
                    </div>
                    <div class="datos">
                        <label>Email:</label>
                        <input type="text" disabled id="email">
                    </div>
                </div>
                <div class="contrasenas-anterior">
                    <div class="datos">
                        <label>Ingrese sus Contraseña Previa:</label>
                        <input type="password" id="contrasena-previa">
                    </div>
                    <div class="datos">
                        <button onclick="comprobar_contrasena()" class="btn-comprabar-con">Comprobar Contraseña</button>
                    </div>
                </div>
                <div class="contrasenas" style="display: none;">
                    <div class="datos">
                        <label>Ingrese la nueva contraseña:</label>
                        <input type="text" id="contrasena">
                    </div>
                    <div class="datos">
                        <label>Confirmar nuueva contraseña:</label>
                        <input type="text" id="confirmar-contrasena">
                    </div>
                </div>
            </div>
            <div class="guardar-info">
                <button onclick="regresar();">Regresar</button>
                <!-- <button id="boton-actualizar" onclick="actualizar_usaurio();">Guardar</button> -->
                <button id="boton-actualizar">Guardar</button>
            </div>
        </div>

        <!--Informacion Empresa-->
        <!-- <div class="contenido">
            <div class="titulo">
                <span>Configuración Empresa</span>
            </div>
            <div class="info-usuario">
                <div class="nombre-usuario">
                    <div class="datos">
                        <label>Nombre Empresa:</label>
                        <input type="text" id="nombre-empresa">
                    </div>
                    <div class="datos">
                        <label>Sector Opera:</label>
                        <input type="text" id="secto-opera">
                    </div>
                </div>
                <div class="usuario-email">
                    <div class="datos">
                        <label>Numero Empleados:</label>
                        <input type="text" id="numero-empleados">
                    </div>
                    <div class="datos">
                        <label>RUC:</label>
                        <input type="text" id="ruc-empresa">
                    </div>
                </div>
            </div>
            <div class="guardar-info">
                <button onclick="regresar();">Regresar</button>
                <button onclick="actualizar_empresa();">Guardar</button>
            </div>
        </div> -->





    </div>
    <!-- Modal cargndo  -->
    <div class="modal-carga" id="modal-carga-id">
        <div class="cotendor-modal" id="cotendor-modal-id">
            <div class="contenido-modal">
                <div class="informacion-modal">
                    <div class="logo-cargando">
                        <div id="logo-modal-1" class="lds-spinner">
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                            <div></div>
                        </div>
                        <i id="logo-modal-2" class="far fa-check-circle"></i>
                    </div>
                    <div class="texto-modal">
                        <span class="mensage-1">Actualizando Datos...</span>
                        <span class="mensage-2">Usuario autentificado correctamente.</span>
                    </div>
                </div>
                <div class="botones-modal">
                    <button id="go_everywhere" onclick="ocultar_modal_cargando()">Acceptar</button>
                    <button style="display: none;" id="cloce_modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal cargando FIn -->

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.4/firebase-app.js'
        import {
            getAuth, updatePassword, createUserWithEmailAndPassword,
            signInWithEmailAndPassword, signOut, onAuthStateChanged,
            GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult
        } from 'https://www.gstatic.com/firebasejs/9.6.4/firebase-auth.js';
        import { getFirestore, collection, query, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.6.4/firebase-firestore.js';
        import { getDatabase, ref, set, child, get, onValue, update }
            from "https://www.gstatic.com/firebasejs/9.6.4/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfmQGYwsGnEo97z2mgJiwEjVW1r4rqntI",
            authDomain: "ejemplo-1-57106.firebaseapp.com",
            projectId: "ejemplo-1-57106",
            storageBucket: "ejemplo-1-57106.appspot.com",
            messagingSenderId: "575633810301",
            appId: "1:575633810301:web:0b6d9d4749eb973f13e214"
        };

        // Inicializacion de Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const fs = getFirestore();
        const provider = new GoogleAuthProvider(app);
        const db = getDatabase();

        const menuToggle = document.querySelector("#menuToggle");
        menuToggle.addEventListener("click", (e) => {
            const toggleMenu = document.querySelector('.menu-salir');
            toggleMenu.classList.toggle('active')
        })
        var tabs = document.querySelectorAll(".tabs ul li");
        var tab_wraps = document.querySelectorAll(".tab_wrap");

        tabs.forEach(function (tab, tab_index) {
            tab.addEventListener("click", function () {
                tabs.forEach(function (tab) {
                    tab.classList.remove("active");
                })
                tab.classList.add("active");

                tab_wraps.forEach(function (content, content_index) {
                    if (content_index == tab_index) {
                        content.style.display = "block";
                    }
                    else {
                        content.style.display = "none";
                    }
                })

            })
        })

        async function updateFirebase(nombre, apellido, email, contrasena, usuario) {
            let id_correo = email.replace(/[^a-zA-Z0-9 ]/g, "");
            await update(ref(db, "UsersList/" + id_correo), {
                name: nombre,
                last_name: apellido,
                email: email,
                contrasena: contrasena,
                usernama: usuario
            })
                .then(() => {
                    console.log('2-> Usuario actualizado Firebase')
                })
                .catch((error) => {
                    console.log("USuario noooooo")
                })

        }
        // actualizamos la autentifciacion del correo y contrasen en firebase 
        async function updateAutentificacionFirebase(email, contrasena) {
            // update contrasena ->https://firebase.google.com/docs/auth/web/manage-users
            const user = auth.currentUser;
            const newPassword = contrasena;
            updatePassword(user, newPassword).then(() => {
                // Update successful.
                console.log("3-> Contrasena de INICIO de seccion actualizada correctamente")
            }).catch((error) => {
                // An error ocurred
                // ...
            });
        }
        // llamamos a las funciones para actualizar los datos
        async function putDatosUsuario() {
            //actualizamos en postegress
            await fetch(`${link_service}consultas/actualizarUsuario/${usuario_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    usuario: document.getElementById('usuario').value,
                    contrasena: contrasena_usuario,
                    encuestado: {
                        nombre: document.getElementById('nombre').value,
                        apellido: document.getElementById('apellido').value,
                        correo: document.getElementById('email').value,
                        encuestado_ID: encuestado_id,
                        empresa: {
                            empresa_ID: empresa_id
                        },
                        terminos_aceptacion: termino_aceptacion_usuario,
                        tipo_cuenta: tipo_cuenta_usuario
                    },
                    administrador_ID: null,
                })
            });
            console.log("1 -> Postgress");
            //actualisamos en firebase
            await updateFirebase(
                document.getElementById('nombre').value,
                document.getElementById('apellido').value,
                document.getElementById('email').value,
                contrasena_usuario,
                document.getElementById('usuario').value);
            // actualizamos la autentificacion 
            await updateAutentificacionFirebase(document.getElementById('email').value, contrasena_usuario);

        }
        // llamar a la funcion desde el botoon para acatualizar datos
        const updateUsuario = document.querySelector("#boton-actualizar");
        updateUsuario.addEventListener("click", (e) => {
            if (comfir_contrasena) {
                // para mostrar el modal cargando 
                mostrar_modal_cargando();
                var contrasena = document.getElementById('contrasena').value;
                var confirmar_contrasena = document.getElementById('confirmar-contrasena').value;
                if (contrasena == confirmar_contrasena) {
                    (async function () {
                        contrasena_usuario = contrasena; // caambiamos la nueva contrasena
                        await putDatosUsuario();
                        user_actualizando_usuario();
                        // swal("Datos actualizados correctamente.")
                    })()
                } else {
                    user_contrasena_no_coincide();
                    // swal("Las contraseñas no coinciden.")
                }
            } else {
                swal('Porfavor confirme su contraseña primero!')
            }
        })
    </script>

</body>
<script src="../js/urls.js"></script>
<script src="../js/perfil_usuario.js"></script>
<!-- para el modela cargando  -->
<script src="../js/modal.js"></script>

</html>